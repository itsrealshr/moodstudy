<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MoodStudy — Recommender</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h1 class="mb-3">MoodStudy — Playlist Recommender</h1>
      <div class="card p-3 mb-3">
        <div class="mb-2">
          <label for="mood" class="form-label">How do you feel?</label>
          <select id="mood" class="form-select">
            <option value="calm">Calm</option>
            <option value="stressed">Stressed</option>
            <option value="tired">Tired</option>
            <option value="bored">Bored</option>
            <option value="happy">Happy</option>
            <option value="anxious">Anxious</option>
          </select>
        </div>
        <div class="mb-2">
          <label for="intent" class="form-label">Study intent</label>
          <select id="intent" class="form-select">
            <option value="focus">Focus</option>
            <option value="memorize">Memorize</option>
            <option value="creative">Creative</option>
            <option value="revision">Revision</option>
            <option value="light_review">Light review</option>
          </select>
        </div>
        <button id="getRec" class="btn btn-primary">Get Recommendation</button>
      </div>

      <div id="result" class="card p-3 d-none">
        <h4 id="plistName"></h4>
        <p id="explanation" class="small text-muted"></p>
        <ul id="tracksList" class="list-group mb-2"></ul>
        <p><strong>Pomodoro:</strong> <span id="pomodoro"></span></p>
        <p id="breathingText"></p>
      </div>

      <div class="mt-4">
        <h5>History (most recent)</h5>
        <ul id="historyList" class="list-group"></ul>
      </div>
    </div>

    <script>
      const getRecBtn = document.getElementById('getRec');
      const resultCard = document.getElementById('result');
      const plistName = document.getElementById('plistName');
      const explanation = document.getElementById('explanation');
      const tracksList = document.getElementById('tracksList');
      const pomodoro = document.getElementById('pomodoro');
      const breathingText = document.getElementById('breathingText');
      const historyList = document.getElementById('historyList');

      async function fetchHistory() {
        const resp = await fetch('/history');
        const data = await resp.json();
        historyList.innerHTML = '';
        data.slice(0,5).forEach(h => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `${h.recommended_at} — mood: ${h.mood} intent: ${h.study_intent} -> playlist ${h.playlist_id}`;
          historyList.appendChild(li);
        });
      }

      getRecBtn.addEventListener('click', async () => {
        const mood = document.getElementById('mood').value;
        const intent = document.getElementById('intent').value;
        const resp = await fetch('/recommend', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({mood, study_intent: intent, user_id: 1})
        });
        if (!resp.ok) {
          alert('Error fetching recommendation');
          return;
        }
        const data = await resp.json();
        resultCard.classList.remove('d-none');
        plistName.textContent = data.playlist_name || 'Playlist';
        explanation.textContent = data.explanation || '';
        tracksList.innerHTML = '';
        (data.tracks || []).forEach(t => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `${t.title} — ${t.artist} (${t.duration})`;
          tracksList.appendChild(li);
        });
        pomodoro.textContent = `${data.pomodoro.work} / ${data.pomodoro.break} minutes`;
        if (data.breathing) {
          breathingText.textContent = `Breathing: ${data.breathing.pattern} for ${data.breathing.duration_seconds} seconds`;
        } else {
          breathingText.textContent = '';
        }
        await fetchHistory();
      });

      fetchHistory();
    </script>
  </body>
</html>
